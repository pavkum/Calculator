var stack={pos:0,elem:[],push:function(e){this.elem[this.pos++]=e},pop:function(){return this.elem[this.pos]=void 0,this.elem[--this.pos]},size:function(){return this.pos},reset:function(){for(;0!==this.pos;)this.pop()}},historyQueue={history:[],push:function(e){10===history.length?this.history.slice(1):this.history.push(e),window.localStorage.setItem("history",JSON.stringify(this.history))},load:function(){this.history=window.localStorage.getItem("history"),$.isEmptyObject(this.history)&&(this.history="[]"),this.history=JSON.parse(this.history)},get:function(){return this.history}},constants={keyListenEventType:"touchstart",moveEventType:"touchmove"},utilities=function(){var e=$("#copy"),t=$("#paste"),i=$("#history"),o=!1,n=($.Event("copy"),$.Event("paste"),$.Event("history"),function(e,t){$("body").trigger("auxilary",[e,t])}),r=function(){n("message","Copied")},s=function(){n("message","Copy Error")},a=function(e){l(e)?n("message","Pasted"):n("message","Invalid char")},c=function(){n("message","Paste Error")},l=function(e){if(e=e.replace(/ /g,""),/[^.\+\-\/\*\^\%\d\(\)\u2200-\u22FF]/.test(e))return!1;for(var t=0;t<e.length;t++)$("body").trigger("display",e.charAt(t));return!0},p=function(){var e=window.historyQueue.get().slice();e=e.reverse();for(var t=0;10>t;t++){var i=e[t];i&&i.expression?($("#expression"+t).text(i.expression.toString().replace(/,/g,"")).css("background","#1E8BC3").css("text-align","left").show(),$("#result"+t).text(i.result).show()):$("#expression"+t).text("No Data").css("background","#19B5FE").css("text-align","right").show()}};e.on(constants.keyListenEventType,function(){for(var e=$("#mainDisplay").text().split("").reverse(),t="",i=0;i<e.length;i++)t+=e[i];return t=t.trim(),""===t?void n("message","Empty"):void cordova.plugins.clipboard.copy(t,r,s)}),t.on(constants.keyListenEventType,function(){cordova.plugins.clipboard.paste(a,c)}),i.on(constants.keyListenEventType,function(){o?(i.text("History"),n("menu","")):(p(),i.text("Keypad"),n("menu","History")),o=!o,$("body").trigger("historynumericpad")}),$("body").on("addToHistory",function(e,t,i){var o={};o.expression=t,o.result=i,window.historyQueue.push(o)}),$(".historyItem").on(constants.keyListenEventType,function(e){var t=$(e.currentTarget).find(".expression");$("body").trigger("clear"),l(t.text())||$("body").trigger("display","Error")}),$("body").on("utilitiesReady",function(){window.historyQueue.load(),$("body").trigger("modechange","basic")})}(),display=function(){var e=$("#mainDisplay"),t=$("#scrollLeft"),i=$("#scrollRight"),o=$("#message"),n=$("#menu"),r=void 0,s=0,a=e,c=function(t){d(),a===e?(a.html(""),a.prepend("<div class='displayCell cursor'>"+t+"</div>"),unitWidth=0,a=e.children().eq(0)):(a.removeClass("cursor"),a.before("<div class='displayCell cursor'>"+t+"</div>"),a=a.prev()),a.addClass("visible"),l(),g()},l=function(){y()&&e.find(".visible").last().removeClass("visible"),y()&&l()},p=function(){y&&e.find(".visible").first().removeClass("visible"),y()&&p()},d=function(){if(!a.is(":visible")){var t=e.find(".cursor").index();if(t<e.find(".visible").first().index())for(var i=e.find(".visible").first().index(),o=0;i>o;o++)u();else for(var i=e.find(".visible").last().index(),o=0;i>o;o++)h()}},u=function(){var t=e.find(".visible").first().prev();t.length>0&&(t.addClass("visible"),l())},h=function(){var t=e.find(".visible").last().next();t.length>0&&(t.addClass("visible"),p())},y=function(){var t=e.prop("scrollHeight");return t>s?!0:!1},v={};v.curX=void 0,v.prevX=void 0,v.timer=void 0;var g=function(){e.find(".visible").last().next().length>0?t.css("visibility","visible"):t.css("visibility","hidden"),e.find(".visible").first().prev().length>0?i.css("visibility","visible"):i.css("visibility","hidden")},f=function(){e.html('<div class="displayCell visible">&nbsp;</div>'),a=e,g()},x=function(){if(d(),a!=e){var t=a.next();a.remove();var i=e.children().length;if(0===t.length&&0!=i)t=e.children().eq(0);else{if(0===i)return void f();var o=e.find(".visible").last().next();o.length>0&&o.addClass("visible")}t.addClass("cursor"),a=t,d(),g()}else f()};$("body").on("displayReady",function(){$.Event("display");s=e.prop("scrollHeight"),f(),$("body").on("display",function(e,t){c(t)}),$("body").on("result",function(t,i){for(var o=0;o<i.length;o++)c(i.charAt(o));a=e}),$("body").on("auxilary",function(e,t,i){"message"===t?(r&&(clearTimeout(r),r=void 0),o.text(i),r=setTimeout(function(){o.text("")},1e3)):"menu"===t&&n.text(i)}),$("body").on("clear",function(){f()}),$("body").on("clearRecent",function(){x()}),e.bind(constants.keyListenEventType,function(t){a!=e&&(a.removeClass("cursor"),a=$(t.target),a.addClass("cursor"))}),e.bind(constants.moveEventType,function(e){var t=e.originalEvent.changedTouches[0].clientX;v.prevX=v.curX,v.curX=t,v.timer&&(clearTimeout(v.timer),v.timer=void 0),v.timer=setTimeout(function(){v.curX=void 0,v.prevX=void 0,v.timer=void 0},1e3),v.curX&&v.prevX&&(v.curX>=v.prevX?h():u(),g()),e.preventDefault()}),$("body").on("screen",function(){var t=$.Deferred(),i={};return i.message=e.text().split("").reverse(),t.resolve(i),t})})}(),key=function(e){this.value=e};key.prototype.attachHandler=function(e){var t=this;$(e).on(constants.keyListenEventType,function(){t.click()})},key.prototype.click=function(){$("body").trigger("display",this.value)};var clearAll=function(){key.call(this,"")};clearAll.prototype=new key,clearAll.prototype.constructor=key,clearAll.prototype.click=function(){$("body").trigger("clear")};var clearRecent=function(){key.call(this,"")};clearRecent.prototype=new key,clearRecent.prototype.constructor=key,clearRecent.prototype.click=function(){$("body").trigger("clearRecent")};var equals=function(){key.call(this,"")};equals.prototype=new key,equals.prototype.constructor=key,equals.prototype.click=function(){$("body").trigger("evaluate")};var keyStore=function(){this.keyStore=[],this.keyStore.equals=new equals,this.keyStore.clearRecent=new clearRecent,this.keyStore.clearAll=new clearAll};keyStore.prototype.getKey=function(e){var t=e.data("type"),i=e.data("key");if("number"===t||"operation"===t){var o=new key(i);return o.attachHandler(e),o}var n=this.keyStore[i];return n?(n.attachHandler(e),n):void 0};var mode=function(){var e=$("#keypad"),t=e.width(),i=e.height(),o=new keyStore,n=($.Event("modechange"),$.Event("keypadReady"),function(e,n){var r=i/e,s=t/n,e=$("#keypad .row");e.width(t),e.height(r),e.css("line-height",r+"px");for(var a=0;a<e.length;a++)for(var c=e.eq(a).children(),l=0;l<c.length;l++){var p=c.eq(l),d=p.data("cell-width")?p.data("cell-width"):1;p.width(d*s),o.getKey(p)}}),r=function(t,i,o){var r="templates/"+t+".html";$.ajax({url:r,method:"GET",success:function(t){e.html(t),n(i,o)},error:function(){e.html("Error occurred while loading keypad...!!!")}})};$("body").on("modechange",function(e,t){"basic"===t&&r("basic",4,6)}),$("body").on("keypadReady",function(){t=e.width(),i=e.height()})}(),SEPERATOR="|",IDGen={id:0,getID:function(){return this.id++}},bodmosExpression=function(){this.expression="",this.id=IDGen.getID(),this.isExpression=function(e){return-1!=e.indexOf("@exp")?!0:!1},this.completionStatus=!1};bodmosExpression.prototype.update=function(e){this.completionStatus||(this.expression+=e+SEPERATOR)},bodmosExpression.prototype.clearRecent=function(e){var t=this.expression.length;this.expression=t>1?this.expression.substr(0,this.expression.length-(e.length+1)):""},bodmosExpression.prototype.getLastExpression=function(){var e;try{e=this.expression.charAt(this.expression.length-2)}catch(t){}return e},bodmosExpression.prototype.clear=function(){},bodmosExpression.prototype.getID=function(){return this.id},bodmosExpression.prototype.complete=function(){this.completionStatus=!0},bodmosExpression.prototype.open=function(){this.completionStatus=!1},bodmosExpression.prototype.getExpression=function(){return this.expression.split(window.SEPERATOR)};var expressionManager=function(){var expressionStore=[],functionStore=[],displayExpression="",show=function(e,t){$("body").trigger("display",[e,t])},active=new window.bodmosExpression;expressionStore[active.getID()]=active;var getExpressionFromId=function(e){return"@exp#"+e},prepareExpression=function(e){for(var t="",i=!1,o=0;o<e.length;o++){var n=e[o];if(isNaN(n))if(-1!=n.indexOf("@exp"))t+="("+prepareExpression(expressionStore[n.substr(5,n.length)].getExpression())+")";else if(n.match("[+*-/]"))i&&(t+=")"),t+=n;else if("%"===n)t+="/100";else if("^"===n){var r,s="";for(r=t.length-1;r>=0&&!isNaN(t.charAt(r));r--)s=t.charAt(r)+s;t=t.substr(0,r+1),t+="Math.pow("+s+",",i=!0}else{var a=t.charAt(t.length-1);isNaN(a)||(t+="*"),t+="Math.sqrt(",i=!0}else t+=n}return i&&(t+=")"),t},update=function(e){if(displayExpression+=e,"("===e){var t=active;window.stack.push(t),active=new window.bodmosExpression,expressionStore[active.getID()]=active,t.update(getExpressionFromId(active.getID()))}else")"===e?window.stack.size()>0&&(active.complete(),active=window.stack.pop()):active.update(e)},clearRecent=function(){var e=displayExpression.length,t=displayExpression.charAt(e-1);if(displayExpression=displayExpression.substr(0,e-1),")"===t){var i=active.getLastExpression();i&&(i=expressionStore[i],window.stack.push(active),i.open(),active=i)}else if("("===t){var o=getExpressionFromId(active.getID());active.clear(),active=window.stack.pop(),active.clearRecent(o)}else active.clearRecent(t);e-1===0||0===e?show("main",0):show("main",displayExpression)},clear=function(){window.stack.reset(),expressionStore=[],displayExpression="",active.complete(),active=new window.bodmosExpression},postProcessExpression=function(e){for(var t="",i=0;i<e.length;i++){var o=e.charAt(i);if("("===o){var n=t.charAt(t.length-1);isNaN(n)&&")"!==n||i-1>=0&&(t+="*")}else")"===o&&i+1<e.length&&(isNaN(e.charAt(i+1))||(o+="*"));t+=o}return t},evaluate=function(his){var val;try{if(val=eval(postProcessExpression(prepareExpression(active.getExpression()))),!val)throw"Error";$("body").trigger("addToHistory",[his,val])}catch(Error){val="Error"}var promise=$.Deferred();promise.done($("body").trigger("clear"),$("body").trigger("result",[val+""]),clear())};$("body").on("expressionManagerReady",function(){$.Event("evaluate"),$("body").on("evaluate",function(){$("body").trigger("auxilary",["message","Evaluating"]);for(var e=$("#mainDisplay").text().split("").reverse(),t="",i=0;i<e.length;i++)t+=e[i],update(e[i]);evaluate(t),$("body").trigger("auxilary",["message","Result"])})})}(),calculator=function(){function e(){$(".container").width(n),$(".container").height(r),n=$(".container").width(),r=$(".container").height(),n>r&&$(".header").css("padding","3%"),$("#auxilary").height(.04*r),$("#auxilary").css("line-height",.04*r+"px"),$(".mainDisplay>table").height(.05*r);var e=r-($(".header").outerHeight()+$(".display").outerHeight()+$(".keypad").outerHeight());$(".keypad").width(n),$(".keypad").height(e),$(".controls").height(.1*e);for(var t=$(".controls .cell"),i=0;i<t.length;i++){var o=t.eq(i);o.height(.1*e),o.css("line-height",.1*e+"px")}var s=$("#keypad");s.width(n),s.height(.9*e),s=$("#calculationHistory"),s.width(n),s.height(.9*e),s=$(".historyItem"),s.width(n),s.css("line-height",.9*e*.1*.96-1+"px"),s.height(.9*e*.1-1)}function t(){$("#keypad").toggle(),$("#calculationHistory").toggle()}function i(){$("body").on("historynumericpad",t),$("body").trigger("keypadReady"),$("body").trigger("displayReady"),$("body").trigger("expressionManagerReady"),$("body").trigger("utilitiesReady")}function o(t){t.orientation&&(n=$(window).width(),r=$(window).height(),"portrait"==$.event.special.orientationchange.orientation(),e())}var n=$(window).width(),r=$(window).height();$(document).on("deviceready",function(){e(),i(),$(window).bind("orientationchange",o)})}();